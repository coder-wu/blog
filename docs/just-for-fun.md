# çžŽæŠ˜è…¾

[EN](#just-for-fun)

> [Homelab](https://github.com/coder-wu/homelab)çš„æ­£ç»ŸREADME

<!-- properties
tag: æ¡ˆä¾‹
created:  2024-01-17 20:47:36
-->

## èµ·é«˜æ¥¼

æ¯ä¸ªç¨‹åºå‘˜éƒ½æƒ³æœ‰ä¸€å°è‡ªå·±çš„æœåŠ¡å™¨ã€‚

2020å¹´ï¼Œæˆ‘ä¹°äº†ä¸€å°NUCï¼Œè£…äº†ä¸€å—1TBçš„å›ºæ€ç¡¬ç›˜å’Œä¸€å—ä»Žè€ç”µè„‘ä¸Šé¢æ‹†ä¸‹æ¥çš„2015å¹´äº§çš„1TBæœºæ¢°ç¡¬ç›˜ã€‚æˆ‘æœ‰ä¸€å°MacBookæ—¥å¸¸ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨NUCä¸Šè£…äº†Windowsä»¥å¤‡ä¸æ—¶ä¹‹éœ€ï¼ˆðŸŽ® æ‰“æ¸¸æˆï¼‰ï¼ŒåŒæ—¶åœ¨NUCä¸Šé¢è·‘ä¸€äº›è€—æ—¶çš„åŽå°ä»»åŠ¡ï¼Œæ¯”å¦‚ä¸‹è½½ç¾Žå‰§å’Œç”µå½±ã€‚

æˆ‘è¿˜åœ¨Windowsä¸Šé¢è£…äº†Linuxè™šæ‹Ÿæœºï¼Œé…ç½®äº†ç½‘ç»œæ¡¥æŽ¥ã€‚æˆ‘åœ¨Macä¸Šé€šè¿‡Microsoft Remote Desktopè¿žæŽ¥Windowsï¼Œé€šè¿‡SSHè¿žæŽ¥åˆ°Linuxè™šæ‹Ÿæœºï¼Œè¿™æ ·æˆ‘å°±åœ¨ä¸€å—å±å¹•ä¸ŠåŒæ—¶æ‹¥æœ‰äº†MacOSã€Windowså’ŒLinuxï¼Œå®Œç¾Žï¼

## å®´å®¾å®¢

æœ‰äº†ä¸€å°å°æœºå™¨ï¼Œæ€»æƒ³å¹²ç‚¹â€œæœ‰è¶£â€çš„äº‹æƒ…ã€‚

### Xray

ç¬¬ä¸€ä»¶â€œæœ‰è¶£â€çš„äº‹æ˜¯æŠŠxrayè·‘åœ¨linuxä¸Šä½œä¸ºå±€åŸŸç½‘çš„ç»Ÿä¸€ä»£ç†ï¼Œ**è¿™æ ·å°±ä¸ç”¨åœ¨æ¯å°è®¾å¤‡éƒ½è£…xrayå®¢æˆ·ç«¯**ï¼Œä¸ºæ­¤å†™äº†Homelabä¸­rayçš„è„šæœ¬ã€‚å½“æ—¶è®¡åˆ’é€šè¿‡å®šæ—¶ä»»åŠ¡æ£€æµ‹ç½‘ç»œçŠ¶æ€ï¼›æ›´æ–°è·¯ç”±æ•°æ®ï¼›åœ¨å¼‚å¸¸æ—¶ä¸»åŠ¨æ›´æ–°è®¢é˜…å¹¶é‡å¯xrayï¼Œæ‰€ä»¥xrayçš„è„šæœ¬ä¸­ä¼šæœ‰æ›´æ–°GEOæ•°æ®ã€æŸ¥è¯¢è®¢é˜…ä¿¡æ¯å’Œæ£€æµ‹ç½‘ç»œçŠ¶æ€è¿™å‡ ä¸ªçœ‹ä¼¼é¸¡è‚‹çš„åŠŸèƒ½ã€‚

### å¤‡ä»½

å¤‡ä»½ï¼Œä¸æ˜¯NASã€‚

å› ä¸ºä¸€å¼€å§‹çš„æƒ³æ³•å°±æ˜¯ç»™Macä¸Šçš„æ–‡ä»¶åšå¤‡ä»½ï¼Œæ‰€ä»¥è¦æ±‚å®‰å…¨å’Œæ–¹ä¾¿æ“ä½œï¼Œå®‰å…¨å°±æ˜¯å¤‡ä»½çš„æ–‡ä»¶éœ€è¦åŠ å¯†ï¼Œæ–¹ä¾¿æ“ä½œæ„å‘³ç€ä¸ç”¨ç»å¸¸æ‰‹åŠ¨è§¦å‘ï¼Œå¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘è¦å°½å¯èƒ½ç®€å•ï¼Œå†æœ‰å°±æ˜¯å¤‡ä»½è¦æ˜¯å¢žé‡å¤‡ä»½ã€‚

æˆ‘åœ¨NUCä¸Šåˆ†å‡ºæ¥ä¸€å—ç¡¬ç›˜ï¼Œç”¨BitLockeråŠ å¯†è§£å†³äº†å®‰å…¨çš„é—®é¢˜ã€‚

å¤‡ä»½é€‰æ‹©äº†syncthingï¼Œåœ¨Windowså’ŒMacä¸Šè£…å¥½åŽï¼Œé…ç½®ä»ŽMacåˆ°Windowsçš„è·¯ç”±è§„åˆ™ã€‚

è‡³æ­¤ä¸€åˆ‡éƒ½å¾ˆå¹³ç¨³ï¼ŒæŒ–äº†ä¸¤ä¸ªå‘ä¹‹åŽï¼Œå¼€å§‹æŒ–ä¸‹ä¸€ä¸ªå‘ï¼šå®¹å™¨ã€‚

### å®¹å™¨

æˆ‘åœ¨Windowsä¸Šåˆ†å‡ºæ¥ä¸¤å°è™šæ‹Ÿæœºï¼Œæ‰“ç®—åœ¨Macä¸Šå†å¼€ä¸€ä¸ªè™šæ‹Ÿæœºé…åˆå®‰è£…ä¸€ä¸ªå°åž‹çš„é«˜å¯ç”¨K8Sé›†ç¾¤ã€‚

æˆ‘çš„Linuxæ˜¯è·‘åœ¨Windowså’ŒMacä¸Šçš„è™šæ‹Ÿæœºï¼Œæ­¤æ—¶ä»Žè£¸é‡‘å±žåˆ°å®¹å™¨çš„è·¯å¾„æ˜¯ï¼šHardWare -> Windows/Mac -> Linux VM -> Containerï¼Œ4å±‚ã€‚

å¦‚æžœåœ¨è£¸é‡‘å±žä¸Šç›´æŽ¥å®‰è£…Linuxä½œä¸ºå®¿ä¸»æœºï¼Œå†åœ¨å®¿ä¸»æœºä¸Šè¿è¡Œå®¹å™¨ï¼Œè·¯å¾„æ˜¯ï¼šHardWare -> Host OS -> Containerï¼Œ3å±‚ã€‚

åœ¨å®žé™…çš„å…¬æœ‰äº‘å’Œç§æœ‰äº‘åœºæ™¯ä¸­ï¼ŒIå±‚çš„èµ„æºåˆè¢«è¿›ä¸€æ­¥æŠ½è±¡ï¼Œæ­¤æ—¶ä»Žè£¸é‡‘å±žåˆ°å®¹å™¨çš„è·¯å¾„å¯èƒ½æ˜¯ï¼š
 - Type1è™šæ‹ŸåŒ–ï¼šHardWare -> Hypervisor -> Linux VM -> Containerï¼Œ4å±‚ã€‚
 - Type2è™šæ‹ŸåŒ–ï¼šHardWare -> Host OS -> Hypervisor -> Linux VM -> Containerï¼Œ5å±‚ã€‚

ä¸€å±‚å±‚åœ°æŠ½è±¡è™šæ‹Ÿä¸‹æ¥æ˜¾å¾—ä¸é‚£ä¹ˆâ€œåˆ©ç´¢â€ã€‚

å¦‚æžœæ˜¯çº¯å®¹å™¨åœºæ™¯ï¼ŒLinux VMé‡‡ç”¨åƒRedHatã€Suseä¹‹ç±»çš„Linuxå‘è¡Œç‰ˆæ˜¾å¾—æœ‰ç‚¹å¤§æå°ç”¨ï¼Œæœ€åŽé€‰æ‹©äº†CoreOSä½œä¸ºå®¹å™¨çš„å®¿ä¸»æœºOSã€‚

> äº‘åŽ‚å•†æä¾›çš„è£¸é‡‘å±žå®¹å™¨ï¼Œè‡³ä»Šæ²¡æœ‰æžæ˜Žç™½æ˜¯ä»€ä¹ˆæ ·çš„æž¶æž„ï¼Œæ€Žä¹ˆå®žçŽ°åœ¨è£¸é‡‘å±žä¸Šé¢ç›´æŽ¥è·‘å®¹å™¨ã€‚

è·Ÿç€K8Sçš„å®˜æ–¹æŒ‡å¯¼ï¼Œå°è¯•äº†å®‰è£…é«˜å¯ç”¨é›†ç¾¤ã€‚ä¸è¿‡MacOSä¸Šçš„è™šæ‹Ÿæœºæ¡¥æŽ¥æ— çº¿ç½‘æ— æ³•è®¿é—®å¤–éƒ¨ç½‘ç»œï¼Œæœ€åŽæ˜¯é€šè¿‡ä¸‰å°è¿è¡Œåœ¨Windowsä¸Šçš„Linux VMæ­å»ºèµ·æ¥çš„ã€‚

åˆ©ç”¨å‘¨æœ«å’Œå¹³å¸¸ä¸‹ç­ä¹‹åŽçš„æ—¶é—´ï¼Œæ•´ä¸ªå®‰è£…æµç¨‹è€—æ—¶å¤§æ¦‚åŠä¸ªæœˆï¼Œé›†ç¾¤å®‰è£…å®Œæˆä¹‹åŽå°è¯•é…ç½®è¿è¡Œäº†Prometheusï¼Œè‡³æ­¤ï¼Œè¿™ä¸ªé›†ç¾¤å°±**å®Œäº†**ã€‚

## æ¥¼å¡Œäº†

996ä¹‹ä¸‹ï¼Œå¦‚æžœæ²¡æœ‰éœ€è¦é•¿æ—¶é—´å ç”¨ç½‘ç»œã€CPUå’ŒGPUè®¡ç®—çš„åŽå°ä»»åŠ¡ï¼Œä¸€ç›´å¼€ç€NUCå¹¶ä¸åˆ’ç®—ã€‚

**ä¸ç”¨åœ¨æ¯å°è®¾å¤‡éƒ½è£…xrayå®¢æˆ·ç«¯æ˜¯ä¸ªä¼ªéœ€æ±‚**ï¼Œå¦‚æžœå‡ºé—¨åœ¨å¤–æˆ–è€…è®¾å¤‡æ¢äº†ä¸ªç½‘ç»œï¼Œè¿˜æ˜¯è¦è¿è¡Œå®¢æˆ·ç«¯ã€‚

NUCä¸ä¸€ç›´è¿è¡Œï¼Œå°±éœ€è¦éš”æ®µæ—¶é—´å¯åŠ¨NUCï¼Œè§£é”BitLockerï¼Œå¯åŠ¨syncthingå¤‡ä»½ã€‚é‚£è¿˜ä¸å¦‚ç›´æŽ¥æŠŠç¡¬ç›˜é€šè¿‡smbæŒ‚è½½ä½¿ç”¨```rsync```å¤‡ä»½ã€‚ ä¸å¦‚ï¼Ÿï¼Ÿ

ä½œä¸ºå­¦ä¹ å’Œå®žè·µï¼Œåœ¨å®‰è£…é«˜å¯ç”¨K8Sé›†ç¾¤è¿‡ç¨‹ä¸­å­¦åˆ°äº†ä¸å°‘å…³äºŽInfraã€OpenStackã€MAASï¼ˆCanonicalï¼‰ã€K8Sã€ETCDçš„çŸ¥è¯†ï¼Œä½œä¸ºè¡¥å……é˜…è¯»å¼€æ‰©çœ¼ç•Œã€‚ä½œä¸ºå¼€å‘çŽ¯å¢ƒï¼Œæˆ‘æ‹’ç»ä½¿ç”¨ï¼ä¸‰ä¸ªè™šæ‹Ÿæœºæ­å»ºçš„é›†ç¾¤è¿è¡Œæ€§èƒ½å ªå¿§ï¼Œç»´æŠ¤éº»çƒ¦ã€‚çŽ¯å¢ƒæ˜¯ä¸ºå¼€å‘æœåŠ¡çš„ï¼Œä¸æ˜¯ä¾›å…»çš„ã€‚

## å°˜å½’å°˜

rayçš„è„šæœ¬å¯ä»¥ç›´æŽ¥æ‹¿æ¥ç”¨åœ¨Macä¸Šï¼Œä¸€é”®å¯åŠ¨é‡å¯ï¼Œå…åŽ»æ‰¾å„ç§å®¢æˆ·ç«¯ï¼Œ**çœå¿ƒï¼Œä¸æŠ˜è…¾**ã€‚

ä¹°ä¸ªç¡¬ç›˜ç›’ï¼Œä¹°ä¸¤å—æœºæ¢°ç¡¬ç›˜ï¼Œ**TimeMachineå¥½ç”¨ï¼Œä¸æŠ˜è…¾**ã€‚

**Minikubeå¥½ç”¨ï¼Œä¸æŠ˜è…¾**ã€‚

---

# Just For Fun

> Real README for [Homelab](https://github.com/coder-wu/homelab)

## 0

Every programmer wants a personal server.

In 2020, I bought a NUC, installed a 1TB SSD and a 1TB HDD produced in 2015 which was removed from an old laptop. I daily use MacBook, so I install Windows on NUC in case for need(ðŸŽ® play games), and run some background tasks like downloading TV series and movies on it.

I also install a Linux VM on Windows with bridge network, so I can connect to Windows by Microsoft Remote Desktop, connect to Linux VM by ssh, and then I have MacOSã€Windowsã€Linux on one screen, bingo!

## 1

No one can set a NUC aside, it has to run something.

### Xray

The first "interesting" thing is to run xray on Linux as a unified proxy for the local area network, **so that I don't need to install the xray client on each device**. For this purpose, I wrote a script for xray in homelab repository. It was planned to provide capabilities like checking the network status, updating routing data, refreshing subscription and restart xray automatically in case of subscription is changed. Therefore, the xray script includes functions such as updating GEO data, querying subscription information, and monitoring network status.

### Back up

Back up, not NAS.

Because I just want to back up files on Mac, so it requires security and easy operation. Security means that the backed up files need to be encrypted. Easy operation means that there is no need to manually trigger it frequently. If it is manually triggered, it should be as simple as possible, the backup must be an incremental backup.

I prepared a disk partition on NUC and used BitLocker encryption to solve the security problem.

I used syncthing for backup, installed it on Windows and Mac, then configured back up rules from Mac to Windows.

So far everything was going well. I started a new way: container.

### Container

I created two VM on Windows and another VM on Mac to install a small high available K8S cluster.

VM is running on Windows and Mac. In this way, the path from bare metal to container is: HardWare -> Windows/Mac -> Linux VM -> Container, 4 layers.

If Linux is directly installed on bare metal as the host, and then run the container on the host, the path is: HardWare -> Host OS -> Container, 3 layers.

In actual public cloud and private cloud scenarios, the resources of infra layer are further abstracted. In this way, the path from bare metal to containers may be:

  - Type 1 hypervisor: HardWare -> Hypervisor -> Linux VM -> Container, 4 layers.
  - Type 2 hypervisor: HardWare -> Host OS -> Hypervisor -> Linux VM -> Container, 5 layers.

The abstraction and virtualization layer by layer does not seem so "clean".

If it is a pure container scenario, it seems a bit overkill to use Linux distributions such as RedHat and Suse for Linux VM. In the end, CoreOS was chosen as the host OS for the container.

> Cloud services provide bare metal containers, but I still donâ€™t understand what kind of architecture it is and how to run containers directly on bare metal.

Following the official guidance of K8S, I tried to install a high available cluster. However, the VM on MacOS with bridge network on wireless cannot access the external network, and it was finally built through three Linux VMs running on Windows.

The entire installation process took about half a month using weekends and time off work. After the cluster installation was completed, I tried to configure and run Prometheus, then this cluster was ```finished```.

## 2

Under 996, if there are no tasks that require network, CPU and GPU for a long time, it is not a good idea to keep the NUC running.

It is't a effective requirement not to install the xray client on every device. If I am away from home or the device changes network, I still need to run the client.

If the NUC does not run all the time, I need to periodically start NUC, unlock BitLocker, and start syncthing. It is better to mount the disk directly through smb and use ```rsync``` backup. Is it better? ?

As a way of learning and practice, I learned a lot about Infra, OpenStack, MAAS (Canonical), K8S, and ETCD during installing high available K8S cluster, which broaden my horizons. As a development environment, I refuse to use it! The cluster built by the three VMs has poor performance and is troublesome to maintain. The environment serves development, not being served.

## Ashes to ashes

The ray script can be used directly on Mac. Xray can be started and restarted with one click, I don't need to find Xray clients. **It is easy to use**.

Buy a hard drive box and two HDDs. **TimeMachine is easy to use**.

**Minikube is easy to use**.
